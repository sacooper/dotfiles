#!/bin/bash

# Send the header so that i3bar knows we want to use JSON:
echo '{"version":1,"click_events":true}'

# Begin the endless array.
echo '['

# We send an empty first array of blocks to make the loop simpler:
echo '[],'

# Now send blocks with information forever:

exec conky -c "$HOME/.conky/.conkyrc" &

OPEN=0
LAST=""

offset() {
    x="$1"
    w="$2"
    if [ "$x" -ge $((1920-w)) -a "$x" -le 1920 ]; then
        echo $((1920-w))
    elif [ "$x" -ge $((2*1920-w)) ]; then
        echo $((2*1920-w))
    else
        echo "$x"
    fi
}

while read line; do
    if [ "$line" = "[" ]; then
        continue
    fi

    #line=$(echo "$line" | sed "s/^,//")
    line=${line/,/}
    name=$(echo "$line" | jshon -e name -u)
    x=$(echo "$line" | jshon -e x -u)

    if [ $OPEN -ne 0 ]; then
        killall lemonbar
        OPEN=0

        if [ "$name" = "$LAST" ]; then
            continue
        fi
    fi

    if [ "$name" = "todo" ]; then
        #c=$(todo -c)
        #offset=1700
        w=350

        x=$(offset "$x" "$w")

        #i3-nagbar -t warning -m "$line" &>/dev/null

        i=0
        todo -b | while read t; do
            echo "  $t" | lemonbar -f "-misc-fixed-medium-r-normal--13-100-100-100-c-70-iso8859-1" -p -d -g "$w""x20+$x+$((20*i+20))" &
            i=$((i+1))
        done
        OPEN=1
    elif [ "$name" = "wifi" ]; then
        w=250
        x=$(offset "$x" "$w")

        iwconfig 2>/dev/null  | grep -o 'ESSID:".\+"' | sed 's/ESSID:"\(.\+\)"/  SSID: \1/' | lemonbar -f "-misc-fixed-medium-r-normal--13-100-100-100-c-70-iso8859-1" -p -d -g "$w""x20+$x+20" &
        (echo -n '  Remote: '; dig +short myip.opendns.com @resolver1.opendns.com) | lemonbar -f "-misc-fixed-medium-r-normal--13-100-100-100-c-70-iso8859-1" -p -d -g "$w""x20+$x+40" &
        ifconfig wlan0 | grep -o 'inet addr:\([0-9]\|\.\)\+' | grep -o '\([0-9]\|\.\)\+' | sed 's/^/  Local: /' | lemonbar -f "-misc-fixed-medium-r-normal--13-100-100-100-c-70-iso8859-1" -p -d -g "$w""x20+$x+60" &

        OPEN=1
    elif [ "$name" = "vpn_up" ]; then
        nmcli con down id sacooper.io &>/dev/null &
    elif [ "$name" = "vpn_down" ]; then
        nmcli con up id sacooper.io &>/dev/null 
    elif [ "$name" = "time" ]; then
        w=350
        x=$(offset "$x" "$w")
        i=0;
        (grep -v '^$' /tmp/gcalcli_agenda.txt | sed 's/^\(... ... [[:digit:]]\+\)/\n%{+u}\1\n/' ) | tail -n+2| while read t; do
            echo "  $t" | lemonbar -f "-misc-fixed-medium-r-normal--13-100-100-100-c-70-iso8859-1" -p -d -g "$w""x20+$x+$((20*i+20))" &
            i=$((i+1))
        done 
        OPEN=1
    elif [ "$name" = "cpu" ]; then
        w=250
        x=$(offset "$x" "$w")
        i=0;
        ps -axo pid,%cpu,comm | sort -r -k2 | head -n10 | while read t; do
            echo "  $t" | lemonbar -f "-misc-fixed-medium-r-normal--13-100-100-100-c-70-iso8859-1" -p -d -g "$w""x20+$x+$((20*i+20))" &
            i=$((i+1))
        done
        OPEN=1
    elif [ "$name" = "mem" ]; then
        w=250
        x=$(offset "$x" "$w")
        i=0;
        ps -axo pid,%mem,comm | sort -r -k2 | head -n10 | while read t; do
            echo "  $t" | lemonbar -f "-misc-fixed-medium-r-normal--13-100-100-100-c-70-iso8859-1" -p -d -g "$w""x20+$x+$((20*i+20))" &
            i=$((i+1))
        done
        OPEN=1
    elif [ "$name" = "volume" ]; then 
        amixer -D pulse set Master toggle &>/dev/null
    elif [ "$name" = "music" ]; then
        button=$(echo "$line" | jshon -e button -u)
        if [ "$button" = "1" ]; then
            mocp -G &>/dev/null
        elif [ "$button" = "3" ]; then
            mocp --next &>/dev/null
        fi
    fi

    if [ "$OPEN" -eq 1 ]; then
        LAST="$name"
    fi
done
